generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id       String      @id @default(uuid())
  email    String      @unique
  password String?
  role     ROLE
  subRole  COACH_ROLE?

  profile Profile?

  coachOfBatches   Batch[]   @relation("BatchCoaches")
  studentOfBatches Batch[]   @relation("BatchStudents")
  adminOfAcademies Academy[] @relation("AcademyAdmins")

  subscriptions Subscription[]

  studentGoals       StudentWeeklyGoal[]
  invitationsCreated Invitation[]

  sentMessages     Message[] @relation("SentMessages")
  receivedMessages Message[] @relation("ReceivedMessages")

  // Friend relations
  sentFriendRequests     FriendRequest[] @relation("SentFriendRequests")
  receivedFriendRequests FriendRequest[] @relation("ReceivedFriendRequests")

  // New Friend relation with distinction for batch and normal friends
  friends      Friend[] @relation("userFriends")
  friendOf     Friend[] @relation("friendFriends")

  notifications Notification[]

  channels Channel[] @relation("ChannelMembers")

  ChannelMessages ChannelMessage[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  status USER_STATUS @default(ACTIVE)

  @@map("users")
}

model Profile {
  id            String   @id @default(uuid())
  firstName     String
  middleName    String?
  lastName      String
  dob           DateTime?
  phoneNumber   String?
  addressLine1  String?
  addressLine2  String?
  city          String?
  state         String?
  country       String?
  parentName    String?
  parentEmailId String?

  userId String? @unique
  user   User?   @relation(fields: [userId], references: [id])

  @@map("profiles")
}

model Academy {
  id String @id @default(uuid())

  name String

  admins  User[]  @relation("AcademyAdmins")
  batches Batch[]

  planId String?
  plan   Plan?   @relation(fields: [planId], references: [id])

  subscriptions  Subscription[]
  purchasedPlans PurchasedPlan[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("academies")
}

model Batch {
  id String @id @default(uuid())

  batchCode   String
  description String?

  studentCapacity Int
  warningCutoff   Int
  currentClass    String
  startLevel      String
  currentLevel    String

  academyId String
  academy   Academy @relation(fields: [academyId], references: [id])

  coaches  User[] @relation("BatchCoaches")
  students User[] @relation("BatchStudents")

  seasonalGoals SeasonalGoal[]
  monthlyGoals  MonthlyGoal[]
  weeklyGoals   WeeklyGoal[]

  startDate DateTime

  channels Channel[]

  messages Message[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("batches")
}

model Invitation {
  id String @id @default(uuid())

  type  INVITATION_TYPE
  email String          @unique

  data      Json?
  expiresAt DateTime?

  status INVITATION_STATUS @default(PENDING)

  createdById String
  createdBy   User   @relation(fields: [createdById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("invitations")
}

model Code {
  id    String @id @default(uuid())
  email String

  code String

  expiresAt DateTime

  type CODE_TYPE

  @@map("codes")
}

model Subscription {
  id String @id @default(uuid())

  userId String
  user   User   @relation(fields: [userId], references: [id])

  planId String
  plan   Plan   @relation(fields: [planId], references: [id])

  academyId String?
  academy   Academy? @relation(fields: [academyId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("subscriptions")
}

model Plan {
  id   String @id @default(uuid())
  name String

  type PLAN_TYPE

  priceMonthly Float
  priceYearly  Float?

  academies      Academy[]
  subscriptions  Subscription[]
  purchasedPlans PurchasedPlan[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("plans")
}

model Coupon {
  id String @id @default(uuid())

  code String @unique

  discount Float
  maxUses  Int

  expiresAt DateTime?

  purchasedPlans PurchasedPlan[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("coupons")
}

model PurchasedPlan {
  id String @id @default(uuid())

  academyId String
  academy   Academy @relation(fields: [academyId], references: [id])

  planId String
  plan   Plan   @relation(fields: [planId], references: [id])

  couponId String?
  coupon   Coupon? @relation(fields: [couponId], references: [id])

  totalPrice Float

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("purchasedplans")
}

model Message {
  id             String   @id @default(uuid())
  senderId       String
  receiverId     String?
  content        String
  isRead         Boolean  @default(false)
  isReplyAllowed Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  sender   User  @relation("SentMessages", fields: [senderId], references: [id])
  receiver User? @relation("ReceivedMessages", fields: [receiverId], references: [id])

  batchId String?
  batch   Batch?  @relation(fields: [batchId], references: [id])

  @@map("messages")
}

model Notification {
  id        String   @id @default(uuid())
  userId    String
  message   String
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])

  @@map("notifications")
}

model FriendRequest {
  id         String                @id @default(uuid())
  senderId   String
  receiverId String
  status     FRIEND_REQUEST_STATUS @default(PENDING)
  createdAt  DateTime              @default(now())
  updatedAt  DateTime              @updatedAt

  sender   User @relation("SentFriendRequests", fields: [senderId], references: [id])
  receiver User @relation("ReceivedFriendRequests", fields: [receiverId], references: [id])

  @@map("friend_requests")
}

model Channel {
  id          String   @id @default(uuid())
  name        String
  isBroadcast Boolean  @default(false)
  batchId     String? 
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  batch   Batch? @relation(fields: [batchId], references: [id])
  members User[] @relation("ChannelMembers")

  messages ChannelMessage[]

  @@map("channels")
}

model ChannelMessage {
  id        String   @id @default(uuid())
  channelId String
  senderId  String
  content   String
  createdAt DateTime @default(now())

  channel Channel @relation(fields: [channelId], references: [id])
  sender  User    @relation(fields: [senderId], references: [id])

  @@map("channel_messages")
}

model StudentWeeklyGoal {
  id            String     @id @default(uuid())
  studentId     String
  weeklyGoalId  String
  puzzlesTarget Int?       @default(0)
  puzzlesSolved Int?       @default(0)
  puzzlesPassed Int?       @default(0)
  isCustom      Boolean    @default(false)
  createdAt     DateTime   @default(now())

  student    User       @relation(fields: [studentId], references: [id])
  weeklyGoal WeeklyGoal @relation(fields: [weeklyGoalId], references: [id])

  @@map("studentweeklygoals")
}

model WeeklyGoal {
  id        String   @id @default(uuid())
  code      String
  startDate DateTime
  endDate   DateTime

  targetId String
  target   Target @relation(fields: [targetId], references: [id])

  monthlyGoalId String
  monthlyGoal   MonthlyGoal @relation(fields: [monthlyGoalId], references: [id])

  batchId String
  batch   Batch @relation(fields: [batchId], references: [id])

  studentGoals StudentWeeklyGoal[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("weeklygoals")
}

model Target {
  id         String       @id @default(uuid())
  noOfGames  Int
  minReviews Int
  midReviews Int
  maxReviews Int

  weeklyGoals WeeklyGoal[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("targets")
}

model MonthlyGoal {
  id        String   @id @default(uuid())
  code      String
  startDate DateTime
  endDate   DateTime

  seasonalGoalId String
  seasonalGoal   SeasonalGoal @relation(fields: [seasonalGoalId], references: [id])

  batchId String
  batch   Batch @relation(fields: [batchId], references: [id])

  weeklyGoals WeeklyGoal[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("monthlygoals")
}

model SeasonalGoal {
  id        String   @id @default(uuid())
  code      String
  startDate DateTime
  endDate   DateTime

  batchId String
  batch   Batch @relation(fields: [batchId], references: [id])

  monthlyGoals MonthlyGoal[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("seasonalgoals")
}

// New Friend model to handle different friendship types
model Friend {
  id        String      @id @default(uuid())
  userId    String
  friendId  String
  type      FRIEND_TYPE @default(NORMAL) // Friend type to differentiate between batch and normal friends
  createdAt DateTime    @default(now())

  user   User @relation("userFriends", fields: [userId], references: [id])
  friend User @relation("friendFriends", fields: [friendId], references: [id])

  @@unique([userId, friendId, type])
  @@map("friends")
}

enum FRIEND_TYPE {
  NORMAL
  BATCH
}

enum GOAL_CATEGORY {
  GAMES
  PUZZLES
}

enum PLAN_TYPE {
  ACADEMY
  SUBSCRIBER
}

enum CODE_TYPE {
  FORGOT_PASSWORD
  LOGIN_WITHOUT_PASSWORD
}

enum INVITATION_TYPE {
  CREATE_ACADEMY
  BATCH_STUDENT
  BATCH_COACH
  USER_INVITATION
}

enum INVITATION_STATUS {
  PENDING
  ACCEPTED
  EXPIRED
  REJECTED
}

enum ROLE {
  SUPER_ADMIN
  ADMIN
  COACH
  STUDENT
  SUBSCRIBER
}

enum COACH_ROLE {
  HEAD_COACH
  SENIOR_COACH
  JUNIOR_COACH
  PUZZLE_MASTER
  PUZZLE_MASTER_SCHOLAR
}

enum FRIEND_REQUEST_STATUS {
  PENDING
  ACCEPTED
  REJECTED
}

enum USER_STATUS {
  ACTIVE
  INACTIVE
}
